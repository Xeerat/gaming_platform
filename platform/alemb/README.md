# Alembic
Alembic - это инструмент миграции базы данных.   
1. Он хранит историю изменений структуры базы (таблицы, столбцы, индексы).   
2. Позволяет автоматически применять изменения схемы на разных компьютерах и окружениях.  
3. Можно откатывать изменения назад, если что-то пошло не так.

То есть Alembic - это git для баз данных. Он сохраняет только структуру, то есть добавленные столбцы, строки, таблицы.   

**ОН НЕ СОХРАНЯЕТ ДАННЫЕ**

## Логика работы
Существует файл модели (`app/migration/models.py`), который описывает структуру таблиц в базе данных. *Alembic* сравнивает эту модель с настоящей базой данных и понимает, какие изменения произошли.   
   
После этого alembic создает файл миграции на основе шаблона `script.py.mako`, в котором описывает все изменения в виде кода.   
   
Все вышесказанное происходит после выполнения команды:
`alembic revision --autogenerate -m "message"`.   
   
После того как создан файл миграции - его можно применять к базе данных.    
Команды применения и отката написаны ниже в теге *`Основные команды alembic`*.   
   
**ПРИМЕНЕНИЯ ФАЙЛОВ МИГРАЦИИ МЕНЯЮТ БАЗУ ДАННЫХ.  
С ЭТИМИ КОМАНДАМИ НУЖНО БЫТЬ АККУРАТНЕЕ.
ОБЯЗАТЕЛЬНО НУЖНО ПРОЧИТАТЬ ОПИСАНИЕ ФАЙЛА `env.py`**

## Основные команды alembic   
`alembic upgrade head` - применить все миграции до последней  
 
`alembic downgrade -1` - откатить последнюю миграцию   

`alembic history` - показать историю всех миграций и их комментарии   

`alembic history --verbose` - показать зависимость между миграциями   

`alembic current` - показать, какая миграция применена к базе в данный момент   

`alembic downgrade base` - откатывает все до самого начала   

## alembic.ini
Это файл конфигурации alembic.  

Там расписаны основные параметры для alembic, а также создаются и описываются логгеры (loggers), обработчики (handlers) и форматтеры (formatters). 
 
Подробнее о них вы можете прочитать в файле `alembic.ini`  

## script.py.mako
Этот шаблон для файлов миграции.  

Каждый раз, когда вы выполняете:  `alembic revision --autogenerate -m "message"`. 

alembic использует этот шаблон для создания нового файла миграции в папке `versions`.   

## app/migration/models.py
Этот код описывающий модели, представляющие таблицы в базе данных.

Если нужно изменить таблицу, то необходимо делать это через этот файл, чтобы другие участники команды понимали структуру таблиц.

## versions/
Папка, где хранятся все миграции. Каждая миграция - это python-файл.  

## env.py 
Файл, который содержит основную структуру для работы alembic.  
Содержит функции для запуска миграций.   

Есть два режима запуска:  
1. Онлайн - `alembic upgrade head`   
2. Оффлайн - `alembic upgrade head --sql > migration.sql`   

**ГЛАВНОЕ РАЗЛИЧИЕ - ПАРАМЕТР `--sql`.
 ЕСЛИ ОН ИСПОЛЬЗУЕТСЯ ТО Alembic НАХОДИТСЯ В ОФФЛАЙН РЕЖИМЕ**
    
Онлайн режим - это режим при котором происходит соединение с базой данных, создание sql-запроса и его выполнение.   
Этот режим напрямую работает с базой данных, что означает, что нужно быть аккуратным, либо не использовать его.      

Оффлайн режим - это режим, в котором создается sql-запрос, который не выполняется автоматически, а сохраняется в файл или выводится в консоль.   
Этот режим не устанавливает соединения с базой данных, поэтому можно не бояться ошибиться - любое ваше изменение не коснется базы данных.   
Все ваши созданные sql-запросы нужно будет выполнить самостоятельно в консоли.   

## .env.example
Пример файла, в котором прописываются важные параметры для соединения с базой данный и т.п.

Нужно создать файл с расширением .env и скопировать туда содержимое этого файла. Потом нужно поменять значения у переменных на свои.

**НУЖНО ПОМЕНЯТЬ ТОЛЬКО ЗНАЧЕНИЯ, КЛЮЧИ МЕНЯТЬ НЕ НУЖНО.
ЗНАЧЕНИЯ НЕ ДОЛЖНЫ СОДЕРЖАТЬ СКОБОК, КАВЫЧЕК И Т.П. БЕЗ НЕОБХОДИМОСТИ**

**ФАЙЛ ЯВЛЯЕТСЯ ПРИМЕРОМ, У НЕГО РАСШИРЕНИЕ env.example.
НАСТОЯЩИЕ ФАЙЛЫ ИМЕЮТ РАСШИРЕНИЕ .env И ОНИ НЕ ДОЛЖНЫ БЫТЬ ОТПРАВЛЕНЫ НА GitHub**

## Удаление миграций
Если появилась необходимость удалить миграции, например они были пробными, то необходимо сначала откатить базу данных до момента в котором они
еще не были применены. 

Только после этого можно удалить файлы миграции из папки `versions/`.

**ЕСЛИ НЕ ОТКАТИТЬ ИЗМЕНЕНИЯ, ТО МОЖНО ПОТЕРЯТЬ СВЯЗЬ МОДЕЛИ И ТАБЛИЦЫ. ЕСЛИ НЕ УВЕРЕНЫ НЕ УДАЛЯЙТЕ**