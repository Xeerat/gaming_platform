# Alembic
Alembic - это инструмент миграции базы данных.   
1. Он хранит историю изменений структуры базы (таблицы, столбцы, индексы).   
2. Позволяет автоматически применять изменения схемы на разных компьютерах и окружениях.  
3. Можно откатывать изменения назад, если что-то пошло не так.  
То есть Alembic - это git hub для баз данных.  
Он сохраняет только структуру, то есть добавленные столбцы, строки, таблицы.  
ОН НЕ СОХРАНЯЕТ ДАННЫЕ.  

## Основные команды alembic
`alembic revision -m "message"` - создать пустую миграцию (Файл миграции по шаблону, но без кода изменения базы данных. Его нужно писать вручную)    
`alembic revision --autogenerate -m "message"` - автоматически создать миграцию (Файл миграции по шаблону с кодом, вносящим изменения в базу данных).
Используется только в *ОНЛАЙН* режиме. Также необходимо создать модель, которая будет описывать изменения в таблице (Записывается модель в переменную `target_metadata`)   
`alembic upgrade head` - применить все миграции до последней   
`alembic downgrade -1` - откать последнюю миграцию   
`alembic history` - показать историю всех миграций и их комментарии   
`alembic history --verbose` - показывает зависимость между миграциями   
`alembic current` - показывает, какая миграция применена к базе в данный момент   
`alembic downgrade base` - откатывает все до самого начала   

## alembic.ini
Это файл конфигурации alembic.  
Там расписаны основные параметры для alembic, а также создаются и описываются логеры, обработчики и форматтеры.  
Подробнее о них вы можете прочитать в файле `alembic.ini`  

## script.py.mako
Этот шаблон для файлов миграции.  
Каждый раз, когда вы выполняете:  
`alembic revision -m "message"`   
`alembic revision --autogenerate -m "message"`   
alembic использует этот шаблон для создания нового файла миграции в папке `versions`.   

## versions/
Папка, где храняться все миграции. Каждая миграция - это python-файл.  

## env.py 
Файл, который содержит основную структуру для работы alembic.  
Содержит функции для запуска миграций.   
Есть два режима запуска:  
1. Онлайн - `alembic upgrade head`   
2. Оффлайн - `alembic upgrade head --sql > migration.sql`   
*ГЛАВНОЕ РАЗЛИЧИЕ - ПАРАМЕТР `--sql`. ЕСЛИ ОН ИСПОЛЬЗУЕТСЯ ТО Alembic НАХОДИТСЯ В ОФФЛАЙН РЕЖИМЕ*   
Онлайн режим - это режим при котором происходит соединение с базой данных, создание sql-запроса и его выполнение.   
Этот режим напрямую работает с базой данных, что означает, что нужно быть аккуратным, либо не использовать его.   
В данном режиме *МОЖНО* запускать автогенерацию: `alembic revision --autogenerate -m "message"`.   

Оффлайн режим - это режим, в котором создается sql-запрос, который не выполняется автоматически, а сохраняется в файл или выводится в консоль.   
Этот режим не устанавливает соединения с базой данных, поэтому можно не бояться ошибиться - любое ваше изменение не коснется базы данных.   
Все ваши созданные sql-запросы нужно будет выполнить самостоятельно в консоли.   
В данном режиме *НЕЛЬЗЯ* запускать автогенерацию: `alembic revision --autogenerate -m "message"`. Можно использовать только пустую миграцию.   

## .env.example
Файл, в котором нужно написать свои значения:  
1. Имя пользователя  
2. Пароль пользователя  
3. Хост  
4. Порт  
5. Название базы данных  
Эти значения будут подставлены в код и использованы для миграции. 
*ФАЙЛ ЯВЛЯЕТСЯ ПРИМЕРОМ, У НЕГО РАСШИРЕНИЕ env.example.*   
*НАСТОЯЩИЕ ФАЙЛЫ ИМЕЮТ РАСШИРЕНИЕ .env И ОНИ НЕ ДОЛЖНЫ БЫТЬ ОТПРАВЛЕНЫ НА GitHub*