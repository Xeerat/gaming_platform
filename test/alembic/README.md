# Alembic
Alembic - это инструмент миграции базы данных.   
1. Он хранит историю изменений структуры базы (таблицы, столбцы, индексы).   
2. Позволяет автоматически применять изменения схемы на разных компьютерах и окружениях.  
3. Можно откатывать изменения назад, если что-то пошло не так.  
То есть Alembic - это git для баз данных.  
Он сохраняет только структуру, то есть добавленные столбцы, строки, таблицы.  
*ОН НЕ СОХРАНЯЕТ ДАННЫЕ*

## Основная логика работы
Существует файл модели (`table_model.py`), который описывает изменения, которые нужно внести в базу данных.   
alembic сравнивает эту модель с настоящей базой данных и понимает, какие изменения произошли.   
После этого alembic создает файл миграции на основе шаблона `script.py.mako`, в котором описывает все изменения в виде кода.   
Происходит это с помощью команды `alembic revision --autogenerate -m "message"`.   
После того как создан файл миграции - его можно применять к базе данных.    
Команды применения и отката написаны ниже в теге `Основные команды alembic`.   
*ПРИМЕНЕНИЯ ФАЙЛОВ МИГРАЦИИ МЕНЯЮТ БАЗУ ДАННЫХ. С ЭТИМИ КОМАНДАМИ НУЖНО БЫТЬ АККУРАТНЕЕ (ОБЯЗАТЕЛЬНО НУЖНО ПРОЧИТАТЬ ОПИСАНИЕ ФАЙЛА `env.py`)*   

## Основные команды alembic   
`alembic upgrade head` - применить все миграции до последней   
`alembic downgrade -1` - откать последнюю миграцию   
`alembic history` - показать историю всех миграций и их комментарии   
`alembic history --verbose` - показывает зависимость между миграциями   
`alembic current` - показывает, какая миграция применена к базе в данный момент   
`alembic downgrade base` - откатывает все до самого начала   

## alembic.ini
Это файл конфигурации alembic.  
Там расписаны основные параметры для alembic, а также создаются и описываются логеры, обработчики и форматтеры.  
Подробнее о них вы можете прочитать в файле `alembic.ini`  

## script.py.mako
Этот шаблон для файлов миграции.  
Каждый раз, когда вы выполняете:  
`alembic revision --autogenerate -m "message"`   
alembic использует этот шаблон для создания нового файла миграции в папке `versions`.   

## app/migration/models.py
Этот код описывающий модели, представляющие таблицы в базе данных.
Если нужно изменить таблицу, то необходимо делать это через этот код, чтобы можно другие участники команды понимали структуру таблиц.

## versions/
Папка, где храняться все миграции. Каждая миграция - это python-файл.  

## env.py 
Файл, который содержит основную структуру для работы alembic.  
Содержит функции для запуска миграций.   
Есть два режима запуска:  
1. Онлайн - `alembic upgrade head`   
2. Оффлайн - `alembic upgrade head --sql > migration.sql`   
*ГЛАВНОЕ РАЗЛИЧИЕ - ПАРАМЕТР `--sql`. ЕСЛИ ОН ИСПОЛЬЗУЕТСЯ ТО Alembic НАХОДИТСЯ В ОФФЛАЙН РЕЖИМЕ*   
Онлайн режим - это режим при котором происходит соединение с базой данных, создание sql-запроса и его выполнение.   
Этот режим напрямую работает с базой данных, что означает, что нужно быть аккуратным, либо не использовать его.      

Оффлайн режим - это режим, в котором создается sql-запрос, который не выполняется автоматически, а сохраняется в файл или выводится в консоль.   
Этот режим не устанавливает соединения с базой данных, поэтому можно не бояться ошибиться - любое ваше изменение не коснется базы данных.   
Все ваши созданные sql-запросы нужно будет выполнить самостоятельно в консоли.   

## .env.example
Файл, в котором нужно написать свои значения:  
1. Имя пользователя  
2. Пароль пользователя  
3. Хост  
4. Порт  
5. Название базы данных  
Эти значения будут подставлены в код и использованы для миграции. 
*ФАЙЛ ЯВЛЯЕТСЯ ПРИМЕРОМ, У НЕГО РАСШИРЕНИЕ env.example.*   
*НАСТОЯЩИЕ ФАЙЛЫ ИМЕЮТ РАСШИРЕНИЕ .env И ОНИ НЕ ДОЛЖНЫ БЫТЬ ОТПРАВЛЕНЫ НА GitHub*

## Удаление миграций
Если появилась необходимость удалить миграции, например они было пробными, то необходимо сначала откатить базу данных до момента в котором они
еще не были применены. 
Только после этого можно удалить файлы миграции из папки `versions/`.
*ЕСЛИ НЕ ОТКАТИТЬ ИЗМЕНЕНИЯ, ТО МОЖНО ПОТЕРЯТЬ СВЯЗЬ МОДЕЛИ И ТАБЛИЦЫ. ЕСЛИ НЕ УВЕРЕНЫ НЕ УДАЛЯЙТЕ*